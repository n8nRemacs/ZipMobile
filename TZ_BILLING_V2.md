# –¢–ó-3: –ú–∏–≥—Ä–∞—Ü–∏—è –±–∏–ª–ª–∏–Ω–≥–∞ ‚Äî —Å–µ—Ä–≤–∏—Å—ã, –ø–ª–∞–Ω—ã, –ø–æ–¥–ø–∏—Å–∫–∏, –º–µ—Å—Ç–∞

## –ö–æ–Ω—Ç–µ–∫—Å—Ç
–ü—Ä–æ–µ–∫—Ç ZipMobile/. –†–∞–±–æ—Ç–∞—é—Ç: tenant-auth (8090), frontend-miniapp (3001), frontend-admin (3000).
–¢–µ–∫—É—â–∏–π –±–∏–ª–ª–∏–Ω–≥: —Ç–∞–±–ª–∏—Ü–∞ billing_plans —Å 3 –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏ (free/starter/pro), –ø–æ–ª–µ tenants.billing_plan_id.
–ù—É–∂–Ω–æ: –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –º–æ–¥–µ–ª—å "–∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç —Å–æ —Å–≤–æ–∏–º–∏ –ø–ª–∞–Ω–∞–º–∏" + –ø–∞–∫–µ—Ç—ã –º–µ—Å—Ç –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ë–î
```
DATABASE_URL=postgresql://postgres.dskhyumhxgbzmuefmrax:Mi31415926pSss!@aws-1-eu-west-1.pooler.supabase.com:5432/postgres
```

---

## –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –±–∏–ª–ª–∏–Ω–≥–∞

### –ü—Ä–∏–Ω—Ü–∏–ø
- –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–ø–æ–∏—Å–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π, –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä, API) ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç
- –£ –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ —Å–≤–æ–∏ —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã (free/standard/pro)
- –¢–µ–Ω–∞–Ω—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –ú–µ—Å—Ç–∞ (—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏) ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
- –õ–∏–º–∏—Ç—ã ‚Äî –¥–Ω–µ–≤–Ω—ã–µ (—Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –≤ 00:00 GMT+3)
- –û–ø–ª–∞—Ç–∞ ‚Äî –ø–æ–º–µ—Å—è—á–Ω–æ (–ø–æ–∑–∂–µ —Å–∫–∏–¥–∫–∏ –∑–∞ –∫–≤–∞—Ä—Ç–∞–ª/–≥–æ–¥)

### –¢–∞—Ä–∏—Ñ–Ω–∞—è —Å–µ—Ç–∫–∞

**–ü–æ–∏—Å–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π (parts_search):**

| –ü–ª–∞–Ω | –¶–µ–Ω–∞ | –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å | –ì–æ–ª–æ—Å –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å |
|------|------|--------------------|--------------------|
| free | 0‚ÇΩ | 5 | 0 |
| standard | 290‚ÇΩ/–º–µ—Å | –±–µ–∑–ª–∏–º–∏—Ç | 3 |
| pro | 590‚ÇΩ/–º–µ—Å | –±–µ–∑–ª–∏–º–∏—Ç | 30 |

**–ê–≤–∏—Ç–æ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä (avito_messenger):**

| –ü–ª–∞–Ω | –¶–µ–Ω–∞ | –ê–∫–∫–∞—É–Ω—Ç—ã | –°–æ–æ–±—â–µ–Ω–∏—è/–¥–µ–Ω—å |
|------|------|----------|---------------|
| free | 0‚ÇΩ | 1 | 50 |
| standard | 990‚ÇΩ/–º–µ—Å | 3 | –±–µ–∑–ª–∏–º–∏—Ç |
| pro | 2990‚ÇΩ/–º–µ—Å | 10 | –±–µ–∑–ª–∏–º–∏—Ç |

**API –¥–æ—Å—Ç—É–ø (api_access):**

| –ü–ª–∞–Ω | –¶–µ–Ω–∞ | –ö–ª—é—á–∏ | –ó–∞–ø—Ä–æ—Å—ã/–¥–µ–Ω—å |
|------|------|-------|-------------|
| free | 0‚ÇΩ | 1 | 100 |
| starter | 490‚ÇΩ/–º–µ—Å | 3 | 1000 |
| pro | 1490‚ÇΩ/–º–µ—Å | 10 | –±–µ–∑–ª–∏–º–∏—Ç |

**–ü–∞–∫–µ—Ç—ã –º–µ—Å—Ç (seats):**

| –ü–∞–∫–µ—Ç | –í—Å–µ–≥–æ –º–µ—Å—Ç | –¶–µ–Ω–∞ | –ó–∞ –º–µ—Å—Ç–æ |
|-------|-----------|------|----------|
| free | 1 (owner) | 0‚ÇΩ | ‚Äî |
| seat_1 | 2 | 190‚ÇΩ/–º–µ—Å | 190‚ÇΩ |
| seat_3 | 4 | 390‚ÇΩ/–º–µ—Å | 130‚ÇΩ |
| seat_5 | 6 | 590‚ÇΩ/–º–µ—Å | 118‚ÇΩ |
| seat_10 | 11 | 990‚ÇΩ/–º–µ—Å | 99‚ÇΩ |

---

## –®–∞–≥ 1: SQL-–º–∏–≥—Ä–∞—Ü–∏—è

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `tenant-auth/migrations/004_billing_v2.sql`:

```sql
-- ============================================
-- 004_billing_v2.sql ‚Äî –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –±–∏–ª–ª–∏–Ω–≥–∞
-- –°–µ—Ä–≤–∏—Å—ã, –ø–ª–∞–Ω—ã, –ø–æ–¥–ø–∏—Å–∫–∏, –º–µ—Å—Ç–∞, —Å—á—ë—Ç—á–∏–∫–∏
-- ============================================

-- –ö–∞—Ç–∞–ª–æ–≥ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
CREATE TABLE IF NOT EXISTS platform_services (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    slug TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    description TEXT,
    icon TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
CREATE TABLE IF NOT EXISTS service_plans (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    service_id UUID NOT NULL REFERENCES platform_services(id) ON DELETE CASCADE,
    slug TEXT NOT NULL,
    name TEXT NOT NULL,
    price_monthly DECIMAL(10,2) DEFAULT 0,
    limits JSONB NOT NULL DEFAULT '{}',
    features JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(service_id, slug)
);

-- –ü–æ–¥–ø–∏—Å–∫–∏ —Ç–µ–Ω–∞–Ω—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã
CREATE TABLE IF NOT EXISTS tenant_subscriptions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    service_id UUID NOT NULL REFERENCES platform_services(id),
    plan_id UUID NOT NULL REFERENCES service_plans(id),
    status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'cancelled', 'expired', 'past_due')),
    started_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ,
    auto_renew BOOLEAN DEFAULT TRUE,
    cancelled_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(tenant_id, service_id)
);

-- –ü–∞–∫–µ—Ç—ã –º–µ—Å—Ç (—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤)
CREATE TABLE IF NOT EXISTS seat_packages (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    slug TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    max_seats INT NOT NULL,
    price_monthly DECIMAL(10,2) DEFAULT 0,
    price_per_seat DECIMAL(10,2),
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ü–æ–¥–ø–∏—Å–∫–∞ —Ç–µ–Ω–∞–Ω—Ç–∞ –Ω–∞ –ø–∞–∫–µ—Ç –º–µ—Å—Ç
CREATE TABLE IF NOT EXISTS tenant_seat_subscriptions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE UNIQUE,
    package_id UUID NOT NULL REFERENCES seat_packages(id),
    status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'cancelled', 'expired')),
    started_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ,
    auto_renew BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- –î–Ω–µ–≤–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
CREATE TABLE IF NOT EXISTS usage_counters (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    service_id UUID NOT NULL REFERENCES platform_services(id),
    counter_name TEXT NOT NULL,
    date DATE NOT NULL DEFAULT CURRENT_DATE,
    used INT NOT NULL DEFAULT 0,
    max_limit INT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(tenant_id, service_id, counter_name, date)
);

-- –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π (–Ω–∞ –±—É–¥—É—â–µ–µ, –ø–æ–∫–∞ –ø—É—Å—Ç–∞—è)
CREATE TABLE IF NOT EXISTS payment_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    amount DECIMAL(10,2) NOT NULL,
    currency TEXT NOT NULL DEFAULT 'RUB',
    description TEXT,
    payment_method TEXT,
    external_id TEXT,
    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'completed', 'failed', 'refunded')),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_service_plans_service ON service_plans(service_id);
CREATE INDEX IF NOT EXISTS idx_tenant_subs_tenant ON tenant_subscriptions(tenant_id);
CREATE INDEX IF NOT EXISTS idx_tenant_subs_service ON tenant_subscriptions(service_id);
CREATE INDEX IF NOT EXISTS idx_tenant_seat_subs_tenant ON tenant_seat_subscriptions(tenant_id);
CREATE INDEX IF NOT EXISTS idx_usage_counters_tenant_date ON usage_counters(tenant_id, date);
CREATE INDEX IF NOT EXISTS idx_usage_counters_lookup ON usage_counters(tenant_id, service_id, counter_name, date);
CREATE INDEX IF NOT EXISTS idx_payment_history_tenant ON payment_history(tenant_id);
```

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `tenant-auth/migrations/005_billing_v2_seed.sql`:

```sql
-- ============================================
-- 005_billing_v2_seed.sql ‚Äî –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–∏–ª–ª–∏–Ω–≥–∞ v2
-- ============================================

-- === –°–µ—Ä–≤–∏—Å—ã ===

INSERT INTO platform_services (id, slug, name, description, icon, sort_order) VALUES
    ('b0000000-0000-0000-0000-000000000001', 'parts_search', '–ü–æ–∏—Å–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π', '–ü–æ–∏—Å–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π –ø–æ –ª—É—á—à–∏–º —Ü–µ–Ω–∞–º –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤. –¢–µ–∫—Å—Ç–æ–≤—ã–π –∏ –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–∏—Å–∫.', 'üîç', 1),
    ('b0000000-0000-0000-0000-000000000002', 'avito_messenger', '–ê–≤–∏—Ç–æ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ Avito. –û–º–Ω–∏–∫–∞–Ω–∞–ª—å–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä.', 'üí¨', 2),
    ('b0000000-0000-0000-0000-000000000003', 'api_access', 'API –¥–æ—Å—Ç—É–ø', '–ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ —á–µ—Ä–µ–∑ API-–∫–ª—é—á–∏.', 'üîë', 3)
ON CONFLICT (slug) DO NOTHING;

-- === –ü–ª–∞–Ω—ã: –ü–æ–∏—Å–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π ===

INSERT INTO service_plans (id, service_id, slug, name, price_monthly, limits, features, sort_order) VALUES
    ('c0000000-0000-0000-0001-000000000001',
     'b0000000-0000-0000-0000-000000000001',
     'free', 'Free', 0,
     '{"text_queries_per_day": 5, "voice_queries_per_day": 0}',
     '{"description": "5 —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å"}',
     1),
    ('c0000000-0000-0000-0001-000000000002',
     'b0000000-0000-0000-0000-000000000001',
     'standard', 'Standard', 290,
     '{"text_queries_per_day": -1, "voice_queries_per_day": 3}',
     '{"description": "–ë–µ–∑–ª–∏–º–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö + 3 –≥–æ–ª–æ—Å–æ–≤—ã—Ö –≤ –¥–µ–Ω—å"}',
     2),
    ('c0000000-0000-0000-0001-000000000003',
     'b0000000-0000-0000-0000-000000000001',
     'pro', 'Pro', 590,
     '{"text_queries_per_day": -1, "voice_queries_per_day": 30}',
     '{"description": "–ë–µ–∑–ª–∏–º–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö + 30 –≥–æ–ª–æ—Å–æ–≤—ã—Ö –≤ –¥–µ–Ω—å"}',
     3)
ON CONFLICT (service_id, slug) DO NOTHING;

-- === –ü–ª–∞–Ω—ã: –ê–≤–∏—Ç–æ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä ===

INSERT INTO service_plans (id, service_id, slug, name, price_monthly, limits, features, sort_order) VALUES
    ('c0000000-0000-0000-0002-000000000001',
     'b0000000-0000-0000-0000-000000000002',
     'free', 'Free', 0,
     '{"accounts": 1, "messages_per_day": 50}',
     '{"description": "1 –∞–∫–∫–∞—É–Ω—Ç, 50 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å"}',
     1),
    ('c0000000-0000-0000-0002-000000000002',
     'b0000000-0000-0000-0000-000000000002',
     'standard', 'Standard', 990,
     '{"accounts": 3, "messages_per_day": -1}',
     '{"description": "3 –∞–∫–∫–∞—É–Ω—Ç–∞, –±–µ–∑–ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"}',
     2),
    ('c0000000-0000-0000-0002-000000000003',
     'b0000000-0000-0000-0000-000000000002',
     'pro', 'Pro', 2990,
     '{"accounts": 10, "messages_per_day": -1}',
     '{"description": "10 –∞–∫–∫–∞—É–Ω—Ç–æ–≤, –±–µ–∑–ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"}',
     3)
ON CONFLICT (service_id, slug) DO NOTHING;

-- === –ü–ª–∞–Ω—ã: API –¥–æ—Å—Ç—É–ø ===

INSERT INTO service_plans (id, service_id, slug, name, price_monthly, limits, features, sort_order) VALUES
    ('c0000000-0000-0000-0003-000000000001',
     'b0000000-0000-0000-0000-000000000003',
     'free', 'Free', 0,
     '{"api_keys": 1, "requests_per_day": 100}',
     '{"description": "1 –∫–ª—é—á, 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å"}',
     1),
    ('c0000000-0000-0000-0003-000000000002',
     'b0000000-0000-0000-0000-000000000003',
     'starter', 'Starter', 490,
     '{"api_keys": 3, "requests_per_day": 1000}',
     '{"description": "3 –∫–ª—é—á–∞, 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å"}',
     2),
    ('c0000000-0000-0000-0003-000000000003',
     'b0000000-0000-0000-0000-000000000003',
     'pro', 'Pro', 1490,
     '{"api_keys": 10, "requests_per_day": -1}',
     '{"description": "10 –∫–ª—é—á–µ–π, –±–µ–∑–ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤"}',
     3)
ON CONFLICT (service_id, slug) DO NOTHING;

-- === –ü–∞–∫–µ—Ç—ã –º–µ—Å—Ç ===

INSERT INTO seat_packages (id, slug, name, max_seats, price_monthly, price_per_seat, sort_order) VALUES
    ('d0000000-0000-0000-0000-000000000001', 'free', '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ', 1, 0, 0, 1),
    ('d0000000-0000-0000-0000-000000000002', 'seat_1', '+1 –º–µ—Å—Ç–æ', 2, 190, 190, 2),
    ('d0000000-0000-0000-0000-000000000003', 'seat_3', '–ü–∞–∫–µ—Ç 3', 4, 390, 130, 3),
    ('d0000000-0000-0000-0000-000000000004', 'seat_5', '–ü–∞–∫–µ—Ç 5', 6, 590, 118, 4),
    ('d0000000-0000-0000-0000-000000000005', 'seat_10', '–ü–∞–∫–µ—Ç 10', 11, 990, 99, 5)
ON CONFLICT (slug) DO NOTHING;

-- === –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ free-–ø–ª–∞–Ω—ã –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ===
-- –≠—Ç–æ –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å—Å—è –≤ –∫–æ–¥–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–Ω–∞–Ω—Ç–∞.
-- –ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ seed-–¥–∞–Ω–Ω—ã–µ.
```

–í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
cd tenant-auth
psql "postgresql://postgres.dskhyumhxgbzmuefmrax:Mi31415926pSss!@aws-1-eu-west-1.pooler.supabase.com:5432/postgres" -f migrations/004_billing_v2.sql
psql "postgresql://postgres.dskhyumhxgbzmuefmrax:Mi31415926pSss!@aws-1-eu-west-1.pooler.supabase.com:5432/postgres" -f migrations/005_billing_v2_seed.sql
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
```sql
SELECT s.slug, sp.slug, sp.price_monthly, sp.limits
FROM service_plans sp
JOIN platform_services s ON s.id = sp.service_id
ORDER BY s.sort_order, sp.sort_order;
```

---

## –®–∞–≥ 2: –°–µ—Ä–≤–∏—Å –±–∏–ª–ª–∏–Ω–≥–∞ v2

–°–æ–∑–¥–∞—Ç—å `src/services/billing_v2_service.py`:

```python
# –ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –±–∏–ª–ª–∏–Ω–≥–∞. –°—Ç–∞—Ä—ã–π billing_service.py –ù–ï —É–¥–∞–ª—è—Ç—å (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å).

# –§—É–Ω–∫—Ü–∏–∏:

# get_platform_services() -> list[dict]
#   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

# get_service_plans(service_slug: str) -> list[dict]
#   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–ª–∞–Ω—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

# get_seat_packages() -> list[dict]
#   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –ø–∞–∫–µ—Ç—ã –º–µ—Å—Ç

# get_tenant_subscriptions(tenant_id: str) -> list[dict]
#   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Ç–µ–Ω–∞–Ω—Ç–∞ (—Å–µ—Ä–≤–∏—Å—ã + –ø–ª–∞–Ω + —Å—Ç–∞—Ç—É—Å)

# get_tenant_seat_info(tenant_id: str) -> dict
#   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞–∫–µ—Ç –º–µ—Å—Ç —Ç–µ–Ω–∞–Ω—Ç–∞ + —Å–∫–æ–ª—å–∫–æ –∑–∞–Ω—è—Ç–æ

# create_free_subscriptions(tenant_id: str)
#   –°–æ–∑–¥–∞—ë—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ free-–ø–ª–∞–Ω –¥–ª—è –í–°–ï–• —Å–µ—Ä–≤–∏—Å–æ–≤ + free –ø–∞–∫–µ—Ç –º–µ—Å—Ç
#   –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞

# check_limit(tenant_id: str, service_slug: str, counter_name: str) -> dict
#   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç: {"allowed": bool, "used": int, "limit": int}
#   –ï—Å–ª–∏ limit = -1 (–±–µ–∑–ª–∏–º–∏—Ç) ‚Üí always allowed

# increment_usage(tenant_id: str, service_slug: str, counter_name: str) -> dict
#   –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –Ω–∞ 1, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {"used": int, "limit": int}
#   –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –µ—Å–ª–∏ –Ω–µ—Ç (upsert)

# get_tenant_billing_summary(tenant_id: str) -> dict
#   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–¥–∫—É: –ø–æ–¥–ø–∏—Å–∫–∏, –º–µ—Å—Ç–∞, –æ–±—â–∞—è —Å—É–º–º–∞/–º–µ—Å
```

### –õ–∏–º–∏—Ç—ã: -1 = –±–µ–∑–ª–∏–º–∏—Ç
–í JSONB limits –∑–Ω–∞—á–µ–Ω–∏–µ -1 –æ–∑–Ω–∞—á–∞–µ—Ç –±–µ–∑–ª–∏–º–∏—Ç. –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ:
```python
if limit == -1:
    return {"allowed": True, "used": used, "limit": "unlimited"}
```

---

## –®–∞–≥ 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ free-–ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

–í `src/services/telegram_auth_service.py` (—Ñ—É–Ω–∫—Ü–∏—è register_via_telegram):
–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è tenant + user ‚Üí –≤—ã–∑–≤–∞—Ç—å `billing_v2_service.create_free_subscriptions(tenant_id)`.

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç:
- –ü–æ–¥–ø–∏—Å–∫—É parts_search ‚Üí free
- –ü–æ–¥–ø–∏—Å–∫—É avito_messenger ‚Üí free
- –ü–æ–¥–ø–∏—Å–∫—É api_access ‚Üí free
- –ü–æ–¥–ø–∏—Å–∫—É seat ‚Üí free (1 –º–µ—Å—Ç–æ)

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤ `src/services/user_service.py` (—Ñ—É–Ω–∫—Ü–∏—è create_tenant_and_user) –¥–ª—è OTP-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

---

## –®–∞–≥ 4: –ù–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –†–æ—É—Ç–µ—Ä: `src/routers/billing_v2.py`

```
GET /auth/v1/billing/v2/services
  ‚Üí –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å –∏—Ö –ø–ª–∞–Ω–∞–º–∏
  ‚Üí –ü—É–±–ª–∏—á–Ω—ã–π (–±–µ–∑ JWT)

GET /auth/v1/billing/v2/seats
  ‚Üí –°–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤ –º–µ—Å—Ç —Å —Ü–µ–Ω–∞–º–∏
  ‚Üí –ü—É–±–ª–∏—á–Ω—ã–π (–±–µ–∑ JWT)

GET /auth/v1/billing/v2/my
  ‚Üí –°–≤–æ–¥–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ (—Å–µ—Ä–≤–∏—Å—ã + –º–µ—Å—Ç–∞ + —Å—É–º–º–∞)
  ‚Üí –¢—Ä–µ–±—É–µ—Ç JWT

GET /auth/v1/billing/v2/usage
  ‚Üí –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –ø–æ –≤—Å–µ–º —Å–µ—Ä–≤–∏—Å–∞–º
  ‚Üí –¢—Ä–µ–±—É–µ—Ç JWT

POST /auth/v1/billing/v2/check-limit
  ‚Üí {"service": "parts_search", "counter": "text_queries_per_day"}
  ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {"allowed": true/false, "used": 3, "limit": 5}
  ‚Üí –¢—Ä–µ–±—É–µ—Ç JWT
```

–ü–æ–¥–∫–ª—é—á–∏—Ç—å –≤ main.py. –î–æ–±–∞–≤–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ –ø—É—Ç–∏ –≤ jwt_auth.py middleware.

–°—Ç–∞—Ä—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã /billing/* –ù–ï —É–¥–∞–ª—è—Ç—å ‚Äî –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å.

---

## –®–∞–≥ 5: –ú–æ–¥–µ–ª–∏

–°–æ–∑–¥–∞—Ç—å `src/models/billing_v2.py`:

```python
from pydantic import BaseModel

class PlatformServiceResponse(BaseModel):
    id: str
    slug: str
    name: str
    description: str | None
    icon: str | None
    plans: list["ServicePlanResponse"]

class ServicePlanResponse(BaseModel):
    id: str
    slug: str
    name: str
    price_monthly: float
    limits: dict
    features: dict

class SeatPackageResponse(BaseModel):
    id: str
    slug: str
    name: str
    max_seats: int
    price_monthly: float
    price_per_seat: float | None

class TenantSubscriptionResponse(BaseModel):
    service_slug: str
    service_name: str
    plan_slug: str
    plan_name: str
    price_monthly: float
    limits: dict
    status: str

class TenantBillingSummary(BaseModel):
    subscriptions: list[TenantSubscriptionResponse]
    seat_package: SeatPackageResponse | None
    seats_used: int
    seats_total: int
    total_monthly: float

class UsageResponse(BaseModel):
    service_slug: str
    counters: dict  # {"text_queries_per_day": {"used": 3, "limit": 5}}

class CheckLimitRequest(BaseModel):
    service: str
    counter: str

class CheckLimitResponse(BaseModel):
    allowed: bool
    used: int
    limit: int | str  # int –∏–ª–∏ "unlimited"
```

---

## –®–∞–≥ 6: –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—à–±–æ—Ä–¥—ã

### Mini App DashboardView
–í–º–µ—Å—Ç–æ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ ‚Üí –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑ GET /billing/v2/my:
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏
- "–ü–æ–∏—Å–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π ‚Äî Free (5 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å)"
- "–ê–≤–∏—Ç–æ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä ‚Äî Free (–∑–∞–≥–ª—É—à–∫–∞)"

### Frontend-admin DashboardView
–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ ‚Äî –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑ API.

---

## –®–∞–≥ 7: –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

–û–±–Ω–æ–≤–∏—Ç—å `tenant-auth/CLAUDE.md`:
- –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—ã –ë–î: platform_services, service_plans, tenant_subscriptions, seat_packages, tenant_seat_subscriptions, usage_counters, payment_history
- –î–æ–±–∞–≤–∏—Ç—å: billing_v2_service.py, routers/billing_v2.py, models/billing_v2.py
- –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏

–û–±–Ω–æ–≤–∏—Ç—å `PROGRESS.md`:
- [x] –ë–∏–ª–ª–∏–Ω–≥ v2: —Å–µ—Ä–≤–∏—Å—ã, –ø–ª–∞–Ω—ã, –ø–æ–¥–ø–∏—Å–∫–∏, –º–µ—Å—Ç–∞ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î + –∑–∞–≥–ª—É—à–∫–∏)
- –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏

---

## –ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å
- –ù–ï —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–π billing_service.py –∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã /billing/*
- –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –æ–ø–ª–∞—Ç—É (–ÆKassa, Stripe –∏ —Ç.–ø.)
- –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ/–æ—Ç–º–µ–Ω—É –ø–æ–¥–ø–∏—Å–æ–∫
- –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å UI –¥–ª—è —Å–º–µ–Ω—ã —Ç–∞—Ä–∏—Ñ–∞ (–ø–æ–∑–∂–µ)
- –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å UI –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –º–µ—Å—Ç (–ø–æ–∑–∂–µ)
- –ù–ï —É–¥–∞–ª—è—Ç—å —Ç–∞–±–ª–∏—Ü—É billing_plans (—Å—Ç–∞—Ä–∞—è, –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
- –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å README.md

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
1. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á–µ—Ä–µ–∑ psql
2. –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª–∏ billing_v2.py
3. –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å billing_v2_service.py
4. –°–æ–∑–¥–∞—Ç—å —Ä–æ—É—Ç–µ—Ä billing_v2.py, –ø–æ–¥–∫–ª—é—á–∏—Ç—å –≤ main.py
5. –î–æ–±–∞–≤–∏—Ç—å create_free_subscriptions –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
6. –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—à–±–æ—Ä–¥—ã (Mini App + frontend-admin) ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ API
7. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å: –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ free-–ø–æ–¥–ø–∏—Å–∫–∏ —Å–æ–∑–¥–∞–ª–∏—Å—å
8. –û–±–Ω–æ–≤–∏—Ç—å CLAUDE.md –∏ PROGRESS.md
