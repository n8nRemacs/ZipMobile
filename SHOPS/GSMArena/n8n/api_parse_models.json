{
  "name": "GSMArena API - Parse Specific Models",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "gsmarena/parse/models",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook",
      "name": "POST /parse/models",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 200],
      "webhookId": "gsmarena-parse-models",
      "notes": "POST body:\n{\n  \"models\": [\n    {\"url\": \"https://gsmarena.com/...\", \"brand\": \"Apple\"},\n    ...\n  ],\n  \"delay_seconds\": 2,\n  \"save_to_db\": true\n}"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body;\n\nif (!body.models || !Array.isArray(body.models) || body.models.length === 0) {\n  throw new Error('Missing required field: models (array of {url, brand})');\n}\n\n// Validate each model\nfor (const m of body.models) {\n  if (!m.url) throw new Error('Each model must have url field');\n  if (!m.brand) throw new Error('Each model must have brand field');\n}\n\nconsole.log(`Received ${body.models.length} models to parse`);\n\nreturn body.models.map((model, index) => ({\n  json: {\n    brand: model.brand,\n    name: model.name || '',\n    url: model.url,\n    gsmarena_id: model.gsmarena_id || null,\n    index: index + 1,\n    total: body.models.length,\n    delay_seconds: body.delay_seconds || 2,\n    save_to_db: body.save_to_db !== false\n  }\n}));"
      },
      "id": "validate",
      "name": "Validate Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 200]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop",
      "name": "Loop Models",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [440, 200]
    },
    {
      "parameters": {
        "amount": "={{ $json.delay_seconds }}",
        "unit": "seconds"
      },
      "id": "wait",
      "name": "Wait",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [660, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.url }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": false,
              "responseFormat": "text"
            }
          },
          "timeout": 30000
        },
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            }
          ]
        }
      },
      "id": "http",
      "name": "Fetch Specs Page",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [880, 200]
    },
    {
      "parameters": {
        "jsCode": "const cheerio = require('cheerio');\nconst modelInfo = $('Wait').first().json;\nconst html = $input.first().json.data;\nconst $ = cheerio.load(html);\n\nfunction extractYear(t) { const m = (t||'').match(/20\\d{2}/); return m ? parseInt(m[0]) : null; }\nfunction extractWeight(t) { const m = (t||'').toLowerCase().match(/(\\d+(?:\\.\\d+)?)\\s*g\\b/); return m ? parseInt(parseFloat(m[1])) : null; }\nfunction extractBattery(t) { const m = (t||'').toLowerCase().match(/(\\d+)\\s*mah/); return m ? parseInt(m[1]) : null; }\nfunction extractPrice(t) { const m = (t||'').toLowerCase().match(/(\\d+(?:\\.\\d+)?)\\s*eur/); return m ? parseFloat(m[1]) : null; }\nfunction extractDisplay(t) { const m = (t||'').toLowerCase().match(/(\\d+(?:\\.\\d+)?)\\s*inch/); return m ? parseFloat(m[1]) : null; }\nfunction extractCamera(t) { const m = (t||'').toLowerCase().match(/(\\d+)\\s*mp/); return m ? m[1] + ' MP' : null; }\n\n// Get model name from page if not provided\nlet modelName = modelInfo.name;\nif (!modelName) {\n  const titleEl = $('h1.specs-phone-name-title');\n  modelName = titleEl.length ? titleEl.text().trim() : 'Unknown';\n}\n\n// Extract gsmarena_id from URL if not provided\nlet gsmId = modelInfo.gsmarena_id;\nif (!gsmId) {\n  const idMatch = modelInfo.url.match(/-(\\d+)\\.php/);\n  gsmId = idMatch ? idMatch[1] : null;\n}\n\nconst specs = { name: modelName, url: modelInfo.url, parsed_at: new Date().toISOString() };\n\n$('table[cellspacing=\"0\"]').each((i, table) => {\n  let cat = null;\n  $(table).find('tr').each((j, row) => {\n    const th = $(row).find('th');\n    if (th.length && th.attr('rowspan')) {\n      cat = th.text().trim().toLowerCase().replace(/\\s+/g, '_');\n      if (!specs[cat]) specs[cat] = {};\n    }\n    const tds = $(row).find('td');\n    if (tds.length >= 2 && cat) {\n      const pn = $(tds[0]).text().trim().toLowerCase().replace(/\\s+/g, '_');\n      const pv = $(tds[1]).text().trim().replace(/\\s+/g, ' ');\n      if (pn && pv) specs[cat][pn] = pv;\n    }\n  });\n});\n\nconst img = $('div.specs-photo-main img');\nif (img.length) specs.image_url = img.attr('src') || '';\nconst pe = $('td[data-spec=\"price\"]');\nif (pe.length) specs.price = pe.text().trim();\n\nconst launch = specs.launch || {};\nconst body = specs.body || {};\nconst display = specs.display || {};\nconst platform = specs.platform || {};\nconst memory = specs.memory || {};\nconst mainCam = specs.main_camera || {};\nconst selfie = specs.selfie_camera || {};\nconst battery = specs.battery || {};\nconst network = specs.network || {};\nconst comms = specs.comms || {};\nconst sound = specs.sound || {};\nconst features = specs.features || {};\nconst misc = specs.misc || {};\n\nconst mcs = mainCam.single || mainCam.dual || mainCam.triple || mainCam.quad || '';\nconst scs = selfie.single || selfie.dual || '';\nconst chg = battery.charging || '';\n\nlet ip = null; const ipm = JSON.stringify(body).match(/IP\\d+/); if (ipm) ip = ipm[0];\nlet rr = null; const rrm = (display.type || '').match(/(\\d+)\\s*Hz/); if (rrm) rr = rrm[1] + 'Hz';\nlet ram = null; const ramm = (memory.internal || '').match(/(\\d+)\\s*GB\\s*RAM/); if (ramm) ram = ramm[1] + ' GB';\nlet wc = null; if (chg.toLowerCase().includes('wireless')) { const wcm = chg.toLowerCase().match(/(\\d+W)\\s*wireless/); wc = wcm ? wcm[1] : 'Yes'; }\n\nconst row = {\n  brand: modelInfo.brand, model_name: modelName, model_url: specs.url,\n  image_url: specs.image_url || '', gsmarena_id: gsmId,\n  announced: launch.announced || '', release_status: launch.status || '', release_year: extractYear(launch.announced),\n  dimensions: body.dimensions || '', weight: body.weight || '', weight_grams: extractWeight(body.weight),\n  build: body.build || '', sim: body.sim || '', ip_rating: ip,\n  display_type: display.type || '', display_size: display.size || '', display_size_inches: extractDisplay(display.size),\n  display_resolution: display.resolution || '', display_protection: display.protection || '', refresh_rate: rr,\n  os: platform.os || '', chipset: platform.chipset || '', cpu: platform.cpu || '', gpu: platform.gpu || '',\n  ram: ram, storage: memory.internal || '', card_slot: memory.card_slot || '',\n  main_camera_mp: extractCamera(mcs), main_camera_setup: mcs, main_camera_features: mainCam.features || '', main_camera_video: mainCam.video || '',\n  selfie_camera_mp: extractCamera(scs), selfie_camera_setup: scs, selfie_camera_video: selfie.video || '',\n  battery_capacity: battery.type || '', battery_capacity_mah: extractBattery(battery.type), battery_type: battery.type || '',\n  charging_wired: chg, charging_wireless: wc,\n  network_technology: network.technology || '', network_2g: network['2g_bands'] || '', network_3g: network['3g_bands'] || '',\n  network_4g: network['4g_bands'] || '', network_5g: network['5g_bands'] || '',\n  wlan: comms.wlan || '', bluetooth: comms.bluetooth || '', nfc: comms.nfc || '', gps: comms.positioning || '', usb: comms.usb || '', radio: comms.radio || '',\n  loudspeaker: sound.loudspeaker || '', audio_jack: sound['3.5mm_jack'] || '', sensors: features.sensors || '',\n  colors: misc.colors || '', models_list: misc.models || '', price: misc.price || specs.price || '', price_eur: extractPrice(misc.price || specs.price || ''),\n  specs_json: JSON.stringify(specs), save_to_db: modelInfo.save_to_db\n};\n\nconsole.log(`[${modelInfo.index}/${modelInfo.total}] Parsed: ${row.model_name}`);\nreturn [{ json: row }];"
      },
      "id": "parse",
      "name": "Parse Specs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 200]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "save",
              "leftValue": "={{ $json.save_to_db }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "check-save",
      "name": "Save to DB?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1320, 200]
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": { "__rl": true, "mode": "list", "value": "public" },
        "table": { "__rl": true, "mode": "list", "value": "zip_gsmarena_raw" },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "brand": "={{ $json.brand }}", "model_name": "={{ $json.model_name }}", "model_url": "={{ $json.model_url }}",
            "image_url": "={{ $json.image_url }}", "gsmarena_id": "={{ $json.gsmarena_id }}",
            "announced": "={{ $json.announced }}", "release_status": "={{ $json.release_status }}", "release_year": "={{ $json.release_year }}",
            "dimensions": "={{ $json.dimensions }}", "weight": "={{ $json.weight }}", "weight_grams": "={{ $json.weight_grams }}",
            "build": "={{ $json.build }}", "sim": "={{ $json.sim }}", "ip_rating": "={{ $json.ip_rating }}",
            "display_type": "={{ $json.display_type }}", "display_size": "={{ $json.display_size }}",
            "display_size_inches": "={{ $json.display_size_inches }}", "display_resolution": "={{ $json.display_resolution }}",
            "display_protection": "={{ $json.display_protection }}", "refresh_rate": "={{ $json.refresh_rate }}",
            "os": "={{ $json.os }}", "chipset": "={{ $json.chipset }}", "cpu": "={{ $json.cpu }}", "gpu": "={{ $json.gpu }}",
            "ram": "={{ $json.ram }}", "storage": "={{ $json.storage }}", "card_slot": "={{ $json.card_slot }}",
            "main_camera_mp": "={{ $json.main_camera_mp }}", "main_camera_setup": "={{ $json.main_camera_setup }}",
            "main_camera_features": "={{ $json.main_camera_features }}", "main_camera_video": "={{ $json.main_camera_video }}",
            "selfie_camera_mp": "={{ $json.selfie_camera_mp }}", "selfie_camera_setup": "={{ $json.selfie_camera_setup }}",
            "selfie_camera_video": "={{ $json.selfie_camera_video }}",
            "battery_capacity": "={{ $json.battery_capacity }}", "battery_capacity_mah": "={{ $json.battery_capacity_mah }}",
            "battery_type": "={{ $json.battery_type }}", "charging_wired": "={{ $json.charging_wired }}", "charging_wireless": "={{ $json.charging_wireless }}",
            "network_technology": "={{ $json.network_technology }}", "network_2g": "={{ $json.network_2g }}",
            "network_3g": "={{ $json.network_3g }}", "network_4g": "={{ $json.network_4g }}", "network_5g": "={{ $json.network_5g }}",
            "wlan": "={{ $json.wlan }}", "bluetooth": "={{ $json.bluetooth }}", "nfc": "={{ $json.nfc }}",
            "gps": "={{ $json.gps }}", "usb": "={{ $json.usb }}", "radio": "={{ $json.radio }}",
            "loudspeaker": "={{ $json.loudspeaker }}", "audio_jack": "={{ $json.audio_jack }}", "sensors": "={{ $json.sensors }}",
            "colors": "={{ $json.colors }}", "models_list": "={{ $json.models_list }}",
            "price": "={{ $json.price }}", "price_eur": "={{ $json.price_eur }}", "specs_json": "={{ $json.specs_json }}"
          }
        },
        "conflictColumns": ["brand", "model_name"],
        "options": {}
      },
      "id": "postgres",
      "name": "PostgreSQL Upsert",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1580, 100],
      "credentials": { "postgres": { "id": "POSTGRES_CREDENTIAL_ID", "name": "PostgreSQL GSMArena" } }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "id": "merge",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1800, 200]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst results = items.map(i => ({\n  model_name: i.json.model_name,\n  brand: i.json.brand,\n  saved: i.json.save_to_db\n}));\n\nreturn [{\n  json: {\n    success: true,\n    total_parsed: items.length,\n    saved_to_db: items.filter(i => i.json.save_to_db).length,\n    results: results\n  }\n}];"
      },
      "id": "summary",
      "name": "Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "response",
      "name": "Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [880, 400]
    }
  ],
  "connections": {
    "POST /parse/models": { "main": [[{ "node": "Validate Input", "type": "main", "index": 0 }]] },
    "Validate Input": { "main": [[{ "node": "Loop Models", "type": "main", "index": 0 }]] },
    "Loop Models": { "main": [[{ "node": "Wait", "type": "main", "index": 0 }], [{ "node": "Summary", "type": "main", "index": 0 }]] },
    "Wait": { "main": [[{ "node": "Fetch Specs Page", "type": "main", "index": 0 }]] },
    "Fetch Specs Page": { "main": [[{ "node": "Parse Specs", "type": "main", "index": 0 }]] },
    "Parse Specs": { "main": [[{ "node": "Save to DB?", "type": "main", "index": 0 }]] },
    "Save to DB?": { "main": [[{ "node": "PostgreSQL Upsert", "type": "main", "index": 0 }], [{ "node": "Merge", "type": "main", "index": 1 }]] },
    "PostgreSQL Upsert": { "main": [[{ "node": "Merge", "type": "main", "index": 0 }]] },
    "Merge": { "main": [[{ "node": "Loop Models", "type": "main", "index": 0 }]] },
    "Summary": { "main": [[{ "node": "Response", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" },
  "staticData": null,
  "tags": ["gsmarena", "api", "parser"]
}
