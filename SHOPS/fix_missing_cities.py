# -*- coding: utf-8 -*-
"""
Дополнение маппинга городов без региона
"""
import psycopg2

DATABASES = [
    'db_greenspark', 'db_taggsm', 'db_memstech', 'db_liberti',
    'db_05gsm', 'db_signal23', 'db_profi', 'db_moba',
    'db_orizhka', 'db_lcdstock', 'db_moysklad'
]

# Дополнительные города (из check_missing_cities.py)
CITY_REGION_MAP = {
    # Кемеровская область (42)
    'Киселёвск': '42',
    'Кемерово': '42',
    'Новокузнецк': '42',
    'Прокопьевск': '42',
    'Ленинск-Кузнецкий': '42',
    'Юрга': '42',

    # Оренбургская область (56)
    'Новотроицк': '56',
    'Оренбург': '56',
    'Орск': '56',

    # Татарстан (16)
    'Елабуга': '16',
    'Казань': '16',
    'Набережные Челны': '16',
    'Нижнекамск': '16',
    'Альметьевск': '16',
    'Зеленодольск': '16',
    'Бугульма': '16',
    'Лениногорск': '16',

    # ХМАО (86)
    'Нефтеюганск': '86',
    'Сургут': '86',
    'Нижневартовск': '86',

    # Красноярский край (24)
    'Ачинск': '24',
    'Красноярск': '24',
    'Норильск': '24',

    # Удмуртия (18)
    'Ижевск': '18',
    'Воткинск': '18',
    'Глазов': '18',

    # Нижегородская область (52)
    'Бор': '52',
    'Нижний Новгород': '52',
    'Дзержинск': '52',

    # Московская область (50)
    'Москва (мосб.)': '50',
    'Москва (МОП)': '50',
    'Подольск': '50',
    'Балашиха': '50',
    'Люберцы': '50',

    # Свердловская область (66)
    'Асбест': '66',
    'Екатеринбург': '66',
    'Нижний Тагил': '66',
    'Каменск-Уральский': '66',
    'Лесной': '66',

    # Пермский край (59)
    'Кудымкар': '59',
    'Пермь': '59',
    'Березники': '59',

    # Иркутская область (38)
    'Шелехов': '38',
    'Иркутск': '38',
    'Братск': '38',
    'Ангарск': '38',

    # Ставропольский край (26)
    'Невинномысск': '26',
    'Ставрополь': '26',
    'Пятигорск': '26',
    'Кисловодск': '26',

    # Республика Коми (11)
    'Усинск': '11',
    'Сыктывкар': '11',
    'Ухта': '11',

    # Краснодарский край (23)
    'Славянск-на-Кубани': '23',
    'Краснодар': '23',
    'Сочи': '23',
    'Новороссийск': '23',

    # Саратовская область (64)
    'Балаково': '64',
    'Саратов': '64',
    'Энгельс': '64',

    # Республика Дагестан (05)
    'Махачкала': '05',
    'Каспийск': '05',
    'Дербент': '05',

    # Чечня (20)
    'Грозный': '20',

    # Самарская область (63)
    'Новокуйбышевск': '63',
    'Самара': '63',
    'Тольятти': '63',

    # Башкортостан (02)
    'Октябрьский': '02',
    'Уфа': '02',
    'Стерлитамак': '02',

    # Новосибирская область (54)
    'Бердск': '54',
    'Новосибирск': '54',

    # Омская область (55)
    'Омск': '55',

    # Томская область (70)
    'Томск': '70',

    # Приморский край (25)
    'Владивосток': '25',
    'Находка': '25',
    'Уссурийск': '25',

    # Хабаровский край (27)
    'Хабаровск': '27',
    'Комсомольск-на-Амуре': '27',

    # Карачаево-Черкесия (09)
    'Черкесск': '09',

    # Кабардино-Балкария (07)
    'Нальчик': '07',

    # Северная Осетия (15)
    'Владикавказ': '15',

    # Калмыкия (08)
    'Элиста': '08',

    # Адыгея (01)
    'Майкоп': '01',

    # Крым (91)
    'Симферополь': '91',
    'Ялта': '91',
    'Евпатория': '91',

    # Волгоградская (34)
    'Волгоград': '34',
    'Волжский': '34',

    # Астраханская (30)
    'Астрахань': '30',

    # Ростовская (61)
    'Ростов-на-Дону': '61',
    'Таганрог': '61',
    'Шахты': '61',
    'Волгодонск': '61',
    'Новочеркасск': '61',
    'Батайск': '61',
    'Каменск-Шахтинский': '61',
    'Азов': '61',
}

def get_conn(db):
    return psycopg2.connect(
        host='85.198.98.104',
        port=5433,
        dbname=db,
        user='postgres',
        password='Mi31415926pSss!'
    )

def fix_cities(db_name):
    print(f'{db_name}: ', end='')
    conn = get_conn(db_name)
    cur = conn.cursor()

    updated = 0
    for city_name, region_code in CITY_REGION_MAP.items():
        cur.execute("""
            UPDATE cities c SET region_id = r.id
            FROM regions r
            WHERE c.name = %s AND r.code = %s AND c.region_id IS NULL
        """, (city_name, region_code))
        updated += cur.rowcount

    conn.commit()

    # Проверяем сколько осталось
    cur.execute("SELECT name FROM cities WHERE region_id IS NULL")
    missing = [r[0] for r in cur.fetchall()]

    print(f'обновлено {updated}, осталось без региона: {len(missing)}')
    if missing:
        print(f'  {missing}')

    conn.close()


if __name__ == '__main__':
    print('Дополнение маппинга городов')
    print('='*50)

    for db in DATABASES:
        try:
            fix_cities(db)
        except Exception as e:
            print(f'{db}: ERROR - {e}')

    print('\nГотово!')
