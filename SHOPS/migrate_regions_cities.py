"""
Миграция справочников регионов и городов во все БД парсеров
"""
import psycopg2

DATABASES = [
    'db_greenspark', 'db_taggsm', 'db_memstech', 'db_liberti',
    'db_05gsm', 'db_signal23', 'db_profi', 'db_moba',
    'db_orizhka', 'db_lcdstock', 'db_moysklad', 'db_zip'
]

# Справочник субъектов РФ из PDF (89 записей)
REGIONS_DATA = [
    ('01', 'Республика Адыгея', 'республика', 'Южный'),
    ('02', 'Республика Башкортостан', 'республика', 'Приволжский'),
    ('03', 'Республика Бурятия', 'республика', 'Дальневосточный'),
    ('04', 'Республика Алтай', 'республика', 'Сибирский'),
    ('05', 'Республика Дагестан', 'республика', 'Северо-Кавказский'),
    ('06', 'Республика Ингушетия', 'республика', 'Северо-Кавказский'),
    ('07', 'Кабардино-Балкарская Республика', 'республика', 'Северо-Кавказский'),
    ('08', 'Республика Калмыкия', 'республика', 'Южный'),
    ('09', 'Карачаево-Черкесская Республика', 'республика', 'Северо-Кавказский'),
    ('10', 'Республика Карелия', 'республика', 'Северо-Западный'),
    ('11', 'Республика Коми', 'республика', 'Северо-Западный'),
    ('12', 'Республика Марий Эл', 'республика', 'Приволжский'),
    ('13', 'Республика Мордовия', 'республика', 'Приволжский'),
    ('14', 'Республика Саха (Якутия)', 'республика', 'Дальневосточный'),
    ('15', 'Республика Северная Осетия - Алания', 'республика', 'Северо-Кавказский'),
    ('16', 'Республика Татарстан', 'республика', 'Приволжский'),
    ('17', 'Республика Тыва', 'республика', 'Сибирский'),
    ('18', 'Удмуртская Республика', 'республика', 'Приволжский'),
    ('19', 'Республика Хакасия', 'республика', 'Сибирский'),
    ('20', 'Чеченская Республика', 'республика', 'Северо-Кавказский'),
    ('21', 'Чувашская Республика', 'республика', 'Приволжский'),
    ('22', 'Алтайский край', 'край', 'Сибирский'),
    ('23', 'Краснодарский край', 'край', 'Южный'),
    ('24', 'Красноярский край', 'край', 'Сибирский'),
    ('25', 'Приморский край', 'край', 'Дальневосточный'),
    ('26', 'Ставропольский край', 'край', 'Северо-Кавказский'),
    ('27', 'Хабаровский край', 'край', 'Дальневосточный'),
    ('28', 'Амурская область', 'область', 'Дальневосточный'),
    ('29', 'Архангельская область', 'область', 'Северо-Западный'),
    ('30', 'Астраханская область', 'область', 'Южный'),
    ('31', 'Белгородская область', 'область', 'Центральный'),
    ('32', 'Брянская область', 'область', 'Центральный'),
    ('33', 'Владимирская область', 'область', 'Центральный'),
    ('34', 'Волгоградская область', 'область', 'Южный'),
    ('35', 'Вологодская область', 'область', 'Северо-Западный'),
    ('36', 'Воронежская область', 'область', 'Центральный'),
    ('37', 'Ивановская область', 'область', 'Центральный'),
    ('38', 'Иркутская область', 'область', 'Сибирский'),
    ('39', 'Калининградская область', 'область', 'Северо-Западный'),
    ('40', 'Калужская область', 'область', 'Центральный'),
    ('41', 'Камчатский край', 'край', 'Дальневосточный'),
    ('42', 'Кемеровская область', 'область', 'Сибирский'),
    ('43', 'Кировская область', 'область', 'Приволжский'),
    ('44', 'Костромская область', 'область', 'Центральный'),
    ('45', 'Курганская область', 'область', 'Уральский'),
    ('46', 'Курская область', 'область', 'Центральный'),
    ('47', 'Ленинградская область', 'область', 'Северо-Западный'),
    ('48', 'Липецкая область', 'область', 'Центральный'),
    ('49', 'Магаданская область', 'область', 'Дальневосточный'),
    ('50', 'Московская область', 'область', 'Центральный'),
    ('51', 'Мурманская область', 'область', 'Северо-Западный'),
    ('52', 'Нижегородская область', 'область', 'Приволжский'),
    ('53', 'Новгородская область', 'область', 'Северо-Западный'),
    ('54', 'Новосибирская область', 'область', 'Сибирский'),
    ('55', 'Омская область', 'область', 'Сибирский'),
    ('56', 'Оренбургская область', 'область', 'Приволжский'),
    ('57', 'Орловская область', 'область', 'Центральный'),
    ('58', 'Пензенская область', 'область', 'Приволжский'),
    ('59', 'Пермский край', 'край', 'Приволжский'),
    ('60', 'Псковская область', 'область', 'Северо-Западный'),
    ('61', 'Ростовская область', 'область', 'Южный'),
    ('62', 'Рязанская область', 'область', 'Центральный'),
    ('63', 'Самарская область', 'область', 'Приволжский'),
    ('64', 'Саратовская область', 'область', 'Приволжский'),
    ('65', 'Сахалинская область', 'область', 'Дальневосточный'),
    ('66', 'Свердловская область', 'область', 'Уральский'),
    ('67', 'Смоленская область', 'область', 'Центральный'),
    ('68', 'Тамбовская область', 'область', 'Центральный'),
    ('69', 'Тверская область', 'область', 'Центральный'),
    ('70', 'Томская область', 'область', 'Сибирский'),
    ('71', 'Тульская область', 'область', 'Центральный'),
    ('72', 'Тюменская область', 'область', 'Уральский'),
    ('73', 'Ульяновская область', 'область', 'Приволжский'),
    ('74', 'Челябинская область', 'область', 'Уральский'),
    ('75', 'Забайкальский край', 'край', 'Дальневосточный'),
    ('76', 'Ярославская область', 'область', 'Центральный'),
    ('77', 'г. Москва', 'город федерального значения', 'Центральный'),
    ('78', 'г. Санкт-Петербург', 'город федерального значения', 'Северо-Западный'),
    ('79', 'Еврейская автономная область', 'автономная область', 'Дальневосточный'),
    ('83', 'Ненецкий автономный округ', 'автономный округ', 'Северо-Западный'),
    ('86', 'Ханты-Мансийский АО - Югра', 'автономный округ', 'Уральский'),
    ('87', 'Чукотский автономный округ', 'автономный округ', 'Дальневосточный'),
    ('89', 'Ямало-Ненецкий автономный округ', 'автономный округ', 'Уральский'),
    ('91', 'Республика Крым', 'республика', 'Южный'),
    ('92', 'г. Севастополь', 'город федерального значения', 'Южный'),
    ('90', 'Запорожская область', 'область', 'Южный'),
    ('93', 'Донецкая Народная Республика', 'республика', 'Южный'),
    ('94', 'Луганская Народная Республика', 'республика', 'Южный'),
    ('95', 'Херсонская область', 'область', 'Южный'),
]

# Маппинг город -> регион (код)
CITY_REGION_MAP = {
    # Города федерального значения
    'Москва': '77', 'Санкт-Петербург': '78', 'Севастополь': '92',
    # Московская область
    'Подольск': '50', 'Балашиха': '50', 'Химки': '50', 'Мытищи': '50',
    'Красногорск': '50', 'Люберцы': '50', 'Королёв': '50', 'Одинцово': '50',
    # Ленинградская область
    'Гатчина': '47', 'Выборг': '47',
    # Республика Татарстан
    'Казань': '16', 'Набережные Челны': '16', 'Нижнекамск': '16', 'Альметьевск': '16',
    # Республика Башкортостан
    'Уфа': '02', 'Стерлитамак': '02', 'Нефтекамск': '02', 'Салават': '02',
    # Краснодарский край
    'Краснодар': '23', 'Сочи': '23', 'Адлер': '23', 'Новороссийск': '23',
    'Анапа': '23', 'Армавир': '23', 'Геленджик': '23', 'Туапсе': '23',
    # Ростовская область
    'Ростов-на-Дону': '61', 'Таганрог': '61', 'Шахты': '61', 'Волгодонск': '61',
    'Новочеркасск': '61', 'Батайск': '61', 'Каменск-Шахтинский': '61', 'Азов': '61',
    # Свердловская область
    'Екатеринбург': '66', 'Нижний Тагил': '66', 'Каменск-Уральский': '66', 'Лесной': '66',
    # Челябинская область
    'Челябинск': '74', 'Магнитогорск': '74', 'Миасс': '74', 'Златоуст': '74',
    # Самарская область
    'Самара': '63', 'Тольятти': '63', 'Сызрань': '63',
    # Нижегородская область
    'Нижний Новгород': '52', 'Дзержинск': '52', 'Арзамас': '52',
    # Новосибирская область
    'Новосибирск': '54', 'Бердск': '54',
    # Омская область
    'Омск': '55',
    # Волгоградская область
    'Волгоград': '34', 'Волжский': '34',
    # Саратовская область
    'Саратов': '64', 'Энгельс': '64', 'Балаково': '64',
    # Воронежская область
    'Воронеж': '36', 'Россошь': '36',
    # Пермский край
    'Пермь': '59', 'Березники': '59',
    # Красноярский край
    'Красноярск': '24', 'Норильск': '24', 'Ачинск': '24',
    # Ставропольский край
    'Ставрополь': '26', 'Пятигорск': '26', 'Кисловодск': '26', 'Невинномысск': '26',
    # Иркутская область
    'Иркутск': '38', 'Братск': '38', 'Ангарск': '38',
    # Тюменская область
    'Тюмень': '72',
    # Оренбургская область
    'Оренбург': '56', 'Орск': '56',
    # Кемеровская область
    'Кемерово': '42', 'Новокузнецк': '42',
    # Ульяновская область
    'Ульяновск': '73',
    # Пензенская область
    'Пенза': '58',
    # Рязанская область
    'Рязань': '62',
    # Липецкая область
    'Липецк': '48',
    # Тульская область
    'Тула': '71', 'Новомосковск': '71',
    # Курская область
    'Курск': '46',
    # Белгородская область
    'Белгород': '31', 'Старый Оскол': '31',
    # Брянская область
    'Брянск': '32',
    # Ивановская область
    'Иваново': '37',
    # Владимирская область
    'Владимир': '33',
    # Тверская область
    'Тверь': '69',
    # Ярославская область
    'Ярославль': '76', 'Рыбинск': '76',
    # Калининградская область
    'Калининград': '39',
    # Архангельская область
    'Архангельск': '29', 'Северодвинск': '29',
    # Вологодская область
    'Вологда': '35', 'Череповец': '35',
    # Мурманская область
    'Мурманск': '51',
    # Астраханская область
    'Астрахань': '30',
    # Кировская область
    'Киров': '43',
    # Смоленская область
    'Смоленск': '67',
    # Тамбовская область
    'Тамбов': '68',
    # Псковская область
    'Псков': '60',
    # Алтайский край
    'Барнаул': '22', 'Бийск': '22', 'Рубцовск': '22',
    # Приморский край
    'Владивосток': '25', 'Находка': '25', 'Уссурийск': '25',
    # Хабаровский край
    'Хабаровск': '27', 'Комсомольск-на-Амуре': '27',
    # Республика Бурятия
    'Улан-Удэ': '03',
    # Республика Коми
    'Сыктывкар': '11', 'Ухта': '11',
    # Республика Карелия
    'Петрозаводск': '10',
    # Республика Марий Эл
    'Йошкар-Ола': '12',
    # Республика Мордовия
    'Саранск': '13',
    # Чувашская Республика
    'Чебоксары': '21', 'Новочебоксарск': '21',
    # Удмуртская Республика
    'Ижевск': '18',
    # Республика Адыгея
    'Майкоп': '01',
    # Республика Калмыкия
    'Элиста': '08',
    # Республика Северная Осетия
    'Владикавказ': '15',
    # Республика Хакасия
    'Абакан': '19',
    # Томская область
    'Томск': '70',
    # Республика Дагестан
    'Махачкала': '05',
    # Республика Саха (Якутия)
    'Якутск': '14',
    # Ямало-Ненецкий АО
    'Ноябрьск': '89', 'Новый Уренгой': '89',
    # Ханты-Мансийский АО
    'Сургут': '86', 'Нижневартовск': '86', 'Ханты-Мансийск': '86',
    # Республика Крым
    'Симферополь': '91',
    # Забайкальский край
    'Чита': '75',
    # Амурская область
    'Благовещенск': '28',
    # Сахалинская область
    'Южно-Сахалинск': '65',
    # Камчатский край
    'Петропавловск-Камчатский': '41',
    # Орловская область
    'Орёл': '57',
    # Костромская область
    'Кострома': '44',
    # Калужская область
    'Калуга': '40',
    # Новгородская область
    'Великий Новгород': '53',
    # Курганская область
    'Курган': '45',
}

def get_conn(db):
    return psycopg2.connect(
        host='85.198.98.104',
        port=5433,
        dbname=db,
        user='postgres',
        password='Mi31415926pSss!'
    )

def migrate_database(db_name):
    """Миграция одной БД"""
    print(f'\n=== {db_name} ===')
    conn = get_conn(db_name)
    cur = conn.cursor()

    # 1. Создаем таблицу regions
    cur.execute("""
        CREATE TABLE IF NOT EXISTS regions (
            id SERIAL PRIMARY KEY,
            code VARCHAR(10) UNIQUE NOT NULL,
            name VARCHAR(200) NOT NULL,
            type VARCHAR(50),
            federal_district VARCHAR(50),
            timezone VARCHAR(50),
            is_active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    """)

    # 2. Создаем/обновляем таблицу cities
    cur.execute("""
        CREATE TABLE IF NOT EXISTS cities (
            id SERIAL PRIMARY KEY,
            name VARCHAR(200) NOT NULL,
            region_id INTEGER REFERENCES regions(id),
            is_regional_center BOOLEAN DEFAULT FALSE,
            population INTEGER,
            timezone VARCHAR(50),
            is_active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    """)

    # Добавляем уникальный индекс на name если его нет
    cur.execute("""
        DO $$ BEGIN
            IF NOT EXISTS (
                SELECT 1 FROM pg_indexes
                WHERE tablename = 'cities' AND indexname = 'cities_name_idx'
            ) THEN
                CREATE UNIQUE INDEX cities_name_idx ON cities(name);
            END IF;
        END $$;
    """)

    # 3. Заполняем regions
    for code, name, rtype, fed_district in REGIONS_DATA:
        cur.execute("""
            INSERT INTO regions (code, name, type, federal_district)
            VALUES (%s, %s, %s, %s)
            ON CONFLICT (code) DO UPDATE SET
                name = EXCLUDED.name,
                type = EXCLUDED.type,
                federal_district = EXCLUDED.federal_district
        """, (code, name, rtype, fed_district))

    conn.commit()

    # Проверяем количество
    cur.execute("SELECT COUNT(*) FROM regions")
    regions_count = cur.fetchone()[0]
    print(f'  regions: {regions_count}')

    # 4. Собираем города из outlets (если таблица есть)
    cur.execute("""
        SELECT EXISTS (
            SELECT FROM information_schema.tables
            WHERE table_name = 'outlets'
        )
    """)
    has_outlets = cur.fetchone()[0]

    if has_outlets:
        cur.execute("SELECT DISTINCT city FROM outlets WHERE city IS NOT NULL")
        outlet_cities = [r[0] for r in cur.fetchall()]

        # Добавляем города
        for city_name in outlet_cities:
            region_code = CITY_REGION_MAP.get(city_name)
            region_id = None

            if region_code:
                cur.execute("SELECT id FROM regions WHERE code = %s", (region_code,))
                result = cur.fetchone()
                if result:
                    region_id = result[0]

            cur.execute("""
                INSERT INTO cities (name, region_id)
                VALUES (%s, %s)
                ON CONFLICT (name) DO UPDATE SET
                    region_id = COALESCE(EXCLUDED.region_id, cities.region_id)
            """, (city_name, region_id))

        conn.commit()

        # 5. Добавляем city_id в outlets если его нет
        cur.execute("""
            SELECT EXISTS (
                SELECT FROM information_schema.columns
                WHERE table_name = 'outlets' AND column_name = 'city_id'
            )
        """)
        has_city_id = cur.fetchone()[0]

        if not has_city_id:
            cur.execute("""
                ALTER TABLE outlets ADD COLUMN city_id INTEGER REFERENCES cities(id)
            """)
            conn.commit()
            print('  + Добавлен city_id в outlets')

        # 6. Заполняем city_id
        cur.execute("""
            UPDATE outlets o
            SET city_id = c.id
            FROM cities c
            WHERE o.city = c.name AND o.city_id IS NULL
        """)
        updated = cur.rowcount
        conn.commit()

        if updated > 0:
            print(f'  + Обновлено {updated} записей в outlets')

    # Итоговая статистика
    cur.execute("SELECT COUNT(*) FROM cities")
    cities_count = cur.fetchone()[0]

    # Города без региона
    cur.execute("SELECT COUNT(*) FROM cities WHERE region_id IS NULL")
    cities_no_region = cur.fetchone()[0]

    print(f'  cities: {cities_count} (без региона: {cities_no_region})')

    if cities_no_region > 0:
        cur.execute("SELECT name FROM cities WHERE region_id IS NULL LIMIT 10")
        no_region_cities = [r[0] for r in cur.fetchall()]
        print(f'    Примеры без региона: {no_region_cities}')

    conn.close()
    return cities_count, cities_no_region


if __name__ == '__main__':
    print('Миграция справочников регионов и городов')
    print('='*50)

    total_cities = 0
    total_no_region = 0

    for db in DATABASES:
        try:
            cnt, no_reg = migrate_database(db)
            total_cities += cnt
            total_no_region += no_reg
        except Exception as e:
            print(f'\n=== {db} === ERROR: {e}')

    print('\n' + '='*50)
    print(f'ИТОГО: {total_cities} городов, {total_no_region} без региона')
